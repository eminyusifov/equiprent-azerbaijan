-- =====================================================\n-- Database Indexes, Functions, Triggers and RLS Policies\n-- =====================================================\n\n-- =====================================================\n-- INDEXES for Performance Optimization\n-- =====================================================\n\n-- Equipment indexes\nCREATE INDEX idx_equipment_category ON public.equipment(category_id);\nCREATE INDEX idx_equipment_available ON public.equipment(available);\nCREATE INDEX idx_equipment_location ON public.equipment(location);\nCREATE INDEX idx_equipment_price_per_day ON public.equipment(price_per_day);\nCREATE INDEX idx_equipment_search_vector ON public.equipment USING GIN(search_vector);\nCREATE INDEX idx_equipment_created_at ON public.equipment(created_at DESC);\n\n-- Booking indexes\nCREATE INDEX idx_bookings_user ON public.bookings(user_id);\nCREATE INDEX idx_bookings_equipment ON public.bookings(equipment_id);\nCREATE INDEX idx_bookings_status ON public.bookings(status);\nCREATE INDEX idx_bookings_dates ON public.bookings(start_date, end_date);\nCREATE INDEX idx_bookings_created_at ON public.bookings(created_at DESC);\nCREATE INDEX idx_bookings_date_range ON public.bookings USING GIST (\n  daterange(start_date, end_date, '[]')\n);\n\n-- Review indexes\nCREATE INDEX idx_reviews_equipment ON public.reviews(equipment_id);\nCREATE INDEX idx_reviews_user ON public.reviews(user_id);\nCREATE INDEX idx_reviews_rating ON public.reviews(rating);\nCREATE INDEX idx_reviews_created_at ON public.reviews(created_at DESC);\n\n-- Favorites indexes\nCREATE INDEX idx_favorites_user ON public.favorites(user_id);\nCREATE INDEX idx_favorites_equipment ON public.favorites(equipment_id);\n\n-- Availability indexes\nCREATE INDEX idx_equipment_availability_date ON public.equipment_availability(equipment_id, date);\n\n-- Notification indexes\nCREATE INDEX idx_notifications_user_unread ON public.notifications(user_id, read) WHERE read = FALSE;\nCREATE INDEX idx_notifications_created_at ON public.notifications(created_at DESC);\n\n-- Payment indexes\nCREATE INDEX idx_payment_transactions_booking ON public.payment_transactions(booking_id);\nCREATE INDEX idx_payment_transactions_user ON public.payment_transactions(user_id);\nCREATE INDEX idx_payment_transactions_status ON public.payment_transactions(status);\n\n-- =====================================================\n-- FUNCTIONS AND TRIGGERS\n-- =====================================================\n\n-- Function to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Triggers for updated_at\nCREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON public.profiles\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_equipment_updated_at BEFORE UPDATE ON public.equipment\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_bookings_updated_at BEFORE UPDATE ON public.bookings\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_reviews_updated_at BEFORE UPDATE ON public.reviews\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nCREATE TRIGGER update_categories_updated_at BEFORE UPDATE ON public.categories\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\n-- Function to handle new user signup\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER AS $$\nBEGIN\n  INSERT INTO public.profiles (id, name, email_verified)\n  VALUES (\n    NEW.id, \n    COALESCE(NEW.raw_user_meta_data->>'name', split_part(NEW.email, '@', 1)),\n    NEW.email_confirmed_at IS NOT NULL\n  );\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n\n-- Trigger for new user\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();\n\n-- Function to calculate equipment rating\nCREATE OR REPLACE FUNCTION calculate_equipment_rating(equipment_uuid UUID)\nRETURNS TABLE(average_rating DECIMAL, review_count INTEGER) AS $$\nBEGIN\n  RETURN QUERY\n  SELECT \n    ROUND(AVG(rating)::numeric, 1) as average_rating,\n    COUNT(*)::INTEGER as review_count\n  FROM public.reviews \n  WHERE equipment_id = equipment_uuid AND is_hidden = FALSE;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Function to check equipment availability\nCREATE OR REPLACE FUNCTION check_equipment_availability(\n  equipment_uuid UUID,\n  start_date_param DATE,\n  end_date_param DATE\n)\nRETURNS BOOLEAN AS $$\nDECLARE\n  conflicting_bookings INTEGER;\n  equipment_available BOOLEAN;\n  blocked_dates INTEGER;\nBEGIN\n  -- Check if equipment exists and is available\n  SELECT available INTO equipment_available\n  FROM public.equipment \n  WHERE id = equipment_uuid;\n  \n  IF NOT FOUND OR NOT equipment_available THEN\n    RETURN FALSE;\n  END IF;\n  \n  -- Check for conflicting bookings\n  SELECT COUNT(*) INTO conflicting_bookings\n  FROM public.bookings\n  WHERE equipment_id = equipment_uuid\n    AND status IN ('confirmed', 'active')\n    AND daterange(start_date, end_date, '[]') && \n        daterange(start_date_param, end_date_param, '[]');\n  \n  -- Check for blocked dates\n  SELECT COUNT(*) INTO blocked_dates\n  FROM public.equipment_availability\n  WHERE equipment_id = equipment_uuid\n    AND available = FALSE\n    AND date >= start_date_param\n    AND date <= end_date_param;\n  \n  RETURN conflicting_bookings = 0 AND blocked_dates = 0;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Function to create notification\nCREATE OR REPLACE FUNCTION create_notification(\n  user_uuid UUID,\n  title_param TEXT,\n  message_param TEXT,\n  type_param TEXT DEFAULT 'info',\n  category_param TEXT DEFAULT 'general',\n  action_url_param TEXT DEFAULT NULL,\n  booking_id_param UUID DEFAULT NULL,\n  equipment_id_param UUID DEFAULT NULL\n)\nRETURNS UUID AS $$\nDECLARE\n  notification_id UUID;\nBEGIN\n  INSERT INTO public.notifications (\n    user_id, title, message, type, category, action_url, \n    related_booking_id, related_equipment_id\n  )\n  VALUES (\n    user_uuid, title_param, message_param, type_param, category_param,\n    action_url_param, booking_id_param, equipment_id_param\n  )\n  RETURNING id INTO notification_id;\n  \n  RETURN notification_id;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Function to log activity\nCREATE OR REPLACE FUNCTION log_activity(\n  user_uuid UUID,\n  action_param TEXT,\n  resource_type_param TEXT,\n  resource_id_param UUID DEFAULT NULL,\n  details_param JSONB DEFAULT NULL\n)\nRETURNS UUID AS $$\nDECLARE\n  log_id UUID;\nBEGIN\n  INSERT INTO public.activity_logs (\n    user_id, action, resource_type, resource_id, details\n  )\n  VALUES (\n    user_uuid, action_param, resource_type_param, resource_id_param, details_param\n  )\n  RETURNING id INTO log_id;\n  \n  RETURN log_id;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on all tables\nALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.equipment ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.bookings ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.reviews ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.favorites ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.equipment_availability ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.maintenance_records ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.payment_transactions ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.equipment_images ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.activity_logs ENABLE ROW LEVEL SECURITY;\n\n-- =====================================================\n-- PROFILES POLICIES\n-- =====================================================\n\n-- Users can view all profiles (for public info)\nCREATE POLICY \"Users can view all profiles\" ON public.profiles\n  FOR SELECT USING (true);\n\n-- Users can update their own profile\nCREATE POLICY \"Users can update own profile\" ON public.profiles\n  FOR UPDATE USING (auth.uid() = id);\n\n-- Admins can update any profile\nCREATE POLICY \"Admins can update any profile\" ON public.profiles\n  FOR UPDATE USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- CATEGORIES POLICIES\n-- =====================================================\n\n-- Anyone can view categories\nCREATE POLICY \"Anyone can view categories\" ON public.categories\n  FOR SELECT USING (true);\n\n-- Only admins can manage categories\nCREATE POLICY \"Admins can manage categories\" ON public.categories\n  FOR ALL USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- EQUIPMENT POLICIES\n-- =====================================================\n\n-- Anyone can view equipment\nCREATE POLICY \"Anyone can view equipment\" ON public.equipment\n  FOR SELECT USING (true);\n\n-- Only admins can manage equipment\nCREATE POLICY \"Admins can manage equipment\" ON public.equipment\n  FOR ALL USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- BOOKINGS POLICIES\n-- =====================================================\n\n-- Users can view their own bookings\nCREATE POLICY \"Users can view own bookings\" ON public.bookings\n  FOR SELECT USING (auth.uid() = user_id);\n\n-- Admins can view all bookings\nCREATE POLICY \"Admins can view all bookings\" ON public.bookings\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- Users can create their own bookings\nCREATE POLICY \"Users can create own bookings\" ON public.bookings\n  FOR INSERT WITH CHECK (auth.uid() = user_id);\n\n-- Users can update their own pending bookings\nCREATE POLICY \"Users can update own pending bookings\" ON public.bookings\n  FOR UPDATE USING (\n    auth.uid() = user_id AND status = 'pending'\n  );\n\n-- Admins can update any booking\nCREATE POLICY \"Admins can update any booking\" ON public.bookings\n  FOR UPDATE USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- REVIEWS POLICIES\n-- =====================================================\n\n-- Anyone can view non-hidden reviews\nCREATE POLICY \"Anyone can view reviews\" ON public.reviews\n  FOR SELECT USING (is_hidden = false);\n\n-- Users can view their own reviews (even if hidden)\nCREATE POLICY \"Users can view own reviews\" ON public.reviews\n  FOR SELECT USING (auth.uid() = user_id);\n\n-- Users can create reviews for their completed bookings\nCREATE POLICY \"Users can create reviews\" ON public.reviews\n  FOR INSERT WITH CHECK (\n    auth.uid() = user_id AND\n    EXISTS (\n      SELECT 1 FROM public.bookings \n      WHERE id = booking_id AND user_id = auth.uid() AND status = 'completed'\n    )\n  );\n\n-- Users can update their own reviews\nCREATE POLICY \"Users can update own reviews\" ON public.reviews\n  FOR UPDATE USING (auth.uid() = user_id);\n\n-- Admins can manage any review\nCREATE POLICY \"Admins can manage reviews\" ON public.reviews\n  FOR ALL USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- FAVORITES POLICIES\n-- =====================================================\n\n-- Users can view their own favorites\nCREATE POLICY \"Users can view own favorites\" ON public.favorites\n  FOR SELECT USING (auth.uid() = user_id);\n\n-- Users can manage their own favorites\nCREATE POLICY \"Users can manage own favorites\" ON public.favorites\n  FOR ALL USING (auth.uid() = user_id);\n\n-- =====================================================\n-- NOTIFICATIONS POLICIES\n-- =====================================================\n\n-- Users can view their own notifications\nCREATE POLICY \"Users can view own notifications\" ON public.notifications\n  FOR SELECT USING (auth.uid() = user_id);\n\n-- Users can update their own notifications (mark as read)\nCREATE POLICY \"Users can update own notifications\" ON public.notifications\n  FOR UPDATE USING (auth.uid() = user_id);\n\n-- Admins can create notifications for any user\nCREATE POLICY \"Admins can create notifications\" ON public.notifications\n  FOR INSERT WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- PAYMENT TRANSACTIONS POLICIES\n-- =====================================================\n\n-- Users can view their own transactions\nCREATE POLICY \"Users can view own transactions\" ON public.payment_transactions\n  FOR SELECT USING (auth.uid() = user_id);\n\n-- Admins can view all transactions\nCREATE POLICY \"Admins can view all transactions\" ON public.payment_transactions\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- Only system can create transactions (through functions)\nCREATE POLICY \"System can create transactions\" ON public.payment_transactions\n  FOR INSERT WITH CHECK (false); -- Will be overridden by functions\n\n-- =====================================================\n-- EQUIPMENT AVAILABILITY POLICIES\n-- =====================================================\n\n-- Anyone can view availability\nCREATE POLICY \"Anyone can view availability\" ON public.equipment_availability\n  FOR SELECT USING (true);\n\n-- Only admins can manage availability\nCREATE POLICY \"Admins can manage availability\" ON public.equipment_availability\n  FOR ALL USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- MAINTENANCE RECORDS POLICIES\n-- =====================================================\n\n-- Only admins can view maintenance records\nCREATE POLICY \"Admins can view maintenance\" ON public.maintenance_records\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- Only admins can manage maintenance records\nCREATE POLICY \"Admins can manage maintenance\" ON public.maintenance_records\n  FOR ALL USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- EQUIPMENT IMAGES POLICIES\n-- =====================================================\n\n-- Anyone can view equipment images\nCREATE POLICY \"Anyone can view equipment images\" ON public.equipment_images\n  FOR SELECT USING (true);\n\n-- Only admins can manage equipment images\nCREATE POLICY \"Admins can manage equipment images\" ON public.equipment_images\n  FOR ALL USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- =====================================================\n-- ACTIVITY LOGS POLICIES\n-- =====================================================\n\n-- Users can view their own activity logs\nCREATE POLICY \"Users can view own activity\" ON public.activity_logs\n  FOR SELECT USING (auth.uid() = user_id);\n\n-- Admins can view all activity logs\nCREATE POLICY \"Admins can view all activity\" ON public.activity_logs\n  FOR SELECT USING (\n    EXISTS (\n      SELECT 1 FROM public.profiles \n      WHERE id = auth.uid() AND is_admin = true\n    )\n  );\n\n-- Activity logs are created by functions only\nCREATE POLICY \"System can create activity logs\" ON public.activity_logs\n  FOR INSERT WITH CHECK (false); -- Will be overridden by functions\n"