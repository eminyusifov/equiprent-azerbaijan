-- =====================================================\n-- Equipment Rental Platform Database Schema\n-- =====================================================\n\n-- Enable required extensions\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";\nCREATE EXTENSION IF NOT EXISTS \"pgcrypto\";\n\n-- =====================================================\n-- 1. Create Categories Table\n-- =====================================================\nCREATE TABLE public.categories (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  name TEXT NOT NULL,\n  name_ru TEXT NOT NULL,\n  name_az TEXT NOT NULL,\n  icon TEXT NOT NULL,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- =====================================================\n-- 2. Create Profiles Table (extends auth.users)\n-- =====================================================\nCREATE TABLE public.profiles (\n  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,\n  name TEXT NOT NULL,\n  phone TEXT,\n  avatar_url TEXT,\n  is_admin BOOLEAN DEFAULT FALSE,\n  email_verified BOOLEAN DEFAULT FALSE,\n  phone_verified BOOLEAN DEFAULT FALSE,\n  address TEXT,\n  city TEXT,\n  country TEXT DEFAULT 'Azerbaijan',\n  date_of_birth DATE,\n  gender TEXT CHECK (gender IN ('male', 'female', 'other')),\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  last_login TIMESTAMP WITH TIME ZONE\n);\n\n-- =====================================================\n-- 3. Create Equipment Table\n-- =====================================================\nCREATE TABLE public.equipment (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  name TEXT NOT NULL,\n  name_ru TEXT NOT NULL,\n  name_az TEXT NOT NULL,\n  category_id UUID REFERENCES public.categories(id) ON DELETE SET NULL,\n  description TEXT NOT NULL,\n  description_ru TEXT NOT NULL,\n  description_az TEXT NOT NULL,\n  specifications JSONB DEFAULT '{}',\n  price_per_day DECIMAL(10,2) NOT NULL CHECK (price_per_day > 0),\n  price_per_week DECIMAL(10,2) NOT NULL CHECK (price_per_week > 0),\n  price_per_month DECIMAL(10,2) NOT NULL CHECK (price_per_month > 0),\n  images TEXT[] DEFAULT '{}',\n  main_image TEXT,\n  available BOOLEAN DEFAULT TRUE,\n  location TEXT NOT NULL,\n  features TEXT[] DEFAULT '{}',\n  condition TEXT DEFAULT 'excellent' CHECK (condition IN ('excellent', 'good', 'fair', 'needs_repair')),\n  year_manufactured INTEGER,\n  brand TEXT,\n  model TEXT,\n  serial_number TEXT UNIQUE,\n  weight_kg DECIMAL(10,2),\n  dimensions JSONB, -- {\"length\": 100, \"width\": 50, \"height\": 30}\n  power_requirements TEXT,\n  fuel_type TEXT,\n  safety_requirements TEXT[],\n  included_accessories TEXT[],\n  deposit_required DECIMAL(10,2) DEFAULT 0,\n  insurance_required BOOLEAN DEFAULT FALSE,\n  minimum_rental_days INTEGER DEFAULT 1,\n  maximum_rental_days INTEGER DEFAULT 365,\n  advance_booking_required BOOLEAN DEFAULT FALSE,\n  advance_booking_days INTEGER DEFAULT 0,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id),\n  \n  -- Полнотекстовый поиск\n  search_vector tsvector GENERATED ALWAYS AS (\n    to_tsvector('english', \n      coalesce(name, '') || ' ' || \n      coalesce(name_ru, '') || ' ' || \n      coalesce(name_az, '') || ' ' || \n      coalesce(description, '') || ' ' || \n      coalesce(brand, '') || ' ' || \n      coalesce(model, '') || ' ' || \n      array_to_string(features, ' ')\n    )\n  ) STORED\n);\n\n-- =====================================================\n-- 4. Create Bookings Table\n-- =====================================================\nCREATE TABLE public.bookings (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  equipment_id UUID REFERENCES public.equipment(id) ON DELETE CASCADE NOT NULL,\n  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  start_date DATE NOT NULL,\n  end_date DATE NOT NULL,\n  total_price DECIMAL(10,2) NOT NULL CHECK (total_price >= 0),\n  deposit_amount DECIMAL(10,2) DEFAULT 0,\n  tax_amount DECIMAL(10,2) DEFAULT 0,\n  discount_amount DECIMAL(10,2) DEFAULT 0,\n  final_amount DECIMAL(10,2) GENERATED ALWAYS AS (total_price + tax_amount - discount_amount) STORED,\n  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'active', 'completed', 'cancelled', 'refunded')),\n  delivery_option TEXT DEFAULT 'pickup' CHECK (delivery_option IN ('pickup', 'delivery')),\n  delivery_address TEXT,\n  delivery_date TIMESTAMP WITH TIME ZONE,\n  return_date TIMESTAMP WITH TIME ZONE,\n  notes TEXT,\n  special_requirements TEXT[],\n  insurance_coverage BOOLEAN DEFAULT FALSE,\n  insurance_amount DECIMAL(10,2) DEFAULT 0,\n  payment_status TEXT DEFAULT 'pending' CHECK (payment_status IN ('pending', 'partial', 'paid', 'refunded')),\n  payment_method TEXT,\n  payment_reference TEXT,\n  confirmation_code TEXT UNIQUE DEFAULT encode(gen_random_bytes(6), 'hex'),\n  cancelled_at TIMESTAMP WITH TIME ZONE,\n  cancellation_reason TEXT,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  \n  -- Проверки\n  CONSTRAINT valid_date_range CHECK (end_date > start_date),\n  CONSTRAINT valid_delivery_address CHECK (\n    (delivery_option = 'delivery' AND delivery_address IS NOT NULL) OR \n    (delivery_option = 'pickup')\n  )\n);\n\n-- =====================================================\n-- 5. Create Reviews Table\n-- =====================================================\nCREATE TABLE public.reviews (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  equipment_id UUID REFERENCES public.equipment(id) ON DELETE CASCADE NOT NULL,\n  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  booking_id UUID REFERENCES public.bookings(id) ON DELETE SET NULL,\n  rating INTEGER CHECK (rating >= 1 AND rating <= 5) NOT NULL,\n  comment TEXT,\n  pros TEXT[],\n  cons TEXT[],\n  would_recommend BOOLEAN DEFAULT TRUE,\n  verified_rental BOOLEAN DEFAULT FALSE,\n  helpful_votes INTEGER DEFAULT 0,\n  reported_count INTEGER DEFAULT 0,\n  is_hidden BOOLEAN DEFAULT FALSE,\n  admin_response TEXT,\n  admin_response_at TIMESTAMP WITH TIME ZONE,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  \n  -- Один отзыв на аренду\n  UNIQUE(booking_id)\n);\n\n-- =====================================================\n-- 6. Create Favorites Table\n-- =====================================================\nCREATE TABLE public.favorites (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  equipment_id UUID REFERENCES public.equipment(id) ON DELETE CASCADE NOT NULL,\n  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  \n  -- Уникальное избранное на пользователя\n  UNIQUE(equipment_id, user_id)\n);\n\n-- =====================================================\n-- 7. Create Equipment Availability Table\n-- =====================================================\nCREATE TABLE public.equipment_availability (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  equipment_id UUID REFERENCES public.equipment(id) ON DELETE CASCADE NOT NULL,\n  date DATE NOT NULL,\n  available BOOLEAN DEFAULT TRUE,\n  reason TEXT, -- 'maintenance', 'booked', 'damaged', etc.\n  notes TEXT,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  \n  UNIQUE(equipment_id, date)\n);\n\n-- =====================================================\n-- 8. Create Maintenance Records Table\n-- =====================================================\nCREATE TABLE public.maintenance_records (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  equipment_id UUID REFERENCES public.equipment(id) ON DELETE CASCADE NOT NULL,\n  maintenance_type TEXT NOT NULL CHECK (maintenance_type IN ('routine', 'repair', 'inspection', 'upgrade')),\n  description TEXT NOT NULL,\n  cost DECIMAL(10,2),\n  performed_by TEXT,\n  maintenance_date DATE NOT NULL,\n  next_maintenance_date DATE,\n  parts_replaced TEXT[],\n  warranty_until DATE,\n  documents TEXT[], -- URLs to maintenance documents\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id)\n);\n\n-- =====================================================\n-- 9. Create Payment Transactions Table\n-- =====================================================\nCREATE TABLE public.payment_transactions (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  booking_id UUID REFERENCES public.bookings(id) ON DELETE CASCADE NOT NULL,\n  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  amount DECIMAL(10,2) NOT NULL,\n  transaction_type TEXT NOT NULL CHECK (transaction_type IN ('payment', 'refund', 'deposit', 'penalty')),\n  payment_method TEXT NOT NULL,\n  payment_gateway TEXT,\n  gateway_transaction_id TEXT,\n  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),\n  gateway_response JSONB,\n  processed_at TIMESTAMP WITH TIME ZONE,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- =====================================================\n-- 10. Create Notifications Table\n-- =====================================================\nCREATE TABLE public.notifications (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  title TEXT NOT NULL,\n  message TEXT NOT NULL,\n  type TEXT DEFAULT 'info' CHECK (type IN ('info', 'success', 'warning', 'error')),\n  category TEXT DEFAULT 'general' CHECK (category IN ('general', 'booking', 'payment', 'maintenance', 'system')),\n  read BOOLEAN DEFAULT FALSE,\n  action_url TEXT,\n  action_label TEXT,\n  related_booking_id UUID REFERENCES public.bookings(id) ON DELETE SET NULL,\n  related_equipment_id UUID REFERENCES public.equipment(id) ON DELETE SET NULL,\n  expires_at TIMESTAMP WITH TIME ZONE,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- =====================================================\n-- 11. Create Equipment Images Table (для множественных изображений)\n-- =====================================================\nCREATE TABLE public.equipment_images (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  equipment_id UUID REFERENCES public.equipment(id) ON DELETE CASCADE NOT NULL,\n  image_url TEXT NOT NULL,\n  is_main BOOLEAN DEFAULT FALSE,\n  alt_text TEXT,\n  sort_order INTEGER DEFAULT 0,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- =====================================================\n-- 12. Create Activity Logs Table\n-- =====================================================\nCREATE TABLE public.activity_logs (\n  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n  action TEXT NOT NULL,\n  resource_type TEXT NOT NULL, -- 'equipment', 'booking', 'user', etc.\n  resource_id UUID,\n  details JSONB,\n  ip_address INET,\n  user_agent TEXT,\n  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n"