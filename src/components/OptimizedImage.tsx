import React, { useState, useRef, useEffect } from 'react';\nimport { useInView } from 'react-intersection-observer';\nimport { ImageOff } from 'lucide-react';\n\ninterface OptimizedImageProps {\n  src: string;\n  alt: string;\n  className?: string;\n  fallbackSrc?: string;\n  sizes?: string;\n  loading?: 'lazy' | 'eager';\n  quality?: number;\n  placeholder?: 'blur' | 'empty';\n  onLoad?: () => void;\n  onError?: () => void;\n}\n\nconst OptimizedImage: React.FC<OptimizedImageProps> = ({ \n  src, \n  alt, \n  className = '',\n  fallbackSrc,\n  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',\n  loading = 'lazy',\n  quality = 75,\n  placeholder = 'blur',\n  onLoad,\n  onError\n}) => {\n  const [isLoaded, setIsLoaded] = useState(false);\n  const [hasError, setHasError] = useState(false);\n  const [currentSrc, setCurrentSrc] = useState(src);\n  const imgRef = useRef<HTMLImageElement>(null);\n  \n  const { ref: inViewRef, inView } = useInView({\n    triggerOnce: true,\n    threshold: 0.1,\n    skip: loading === 'eager'\n  });\n\n  // Объединяем рефы\n  const setRefs = (element: HTMLImageElement | null) => {\n    imgRef.current = element;\n    inViewRef(element);\n  };\n\n  const shouldLoad = loading === 'eager' || inView;\n\n  const handleLoad = () => {\n    setIsLoaded(true);\n    onLoad?.();\n  };\n\n  const handleError = () => {\n    setHasError(true);\n    if (fallbackSrc && currentSrc !== fallbackSrc) {\n      setCurrentSrc(fallbackSrc);\n      setHasError(false);\n    } else {\n      onError?.();\n    }\n  };\n\n  // Генерация оптимизированного URL (если используется CDN)\n  const getOptimizedSrc = (url: string) => {\n    // Здесь можно добавить логику для различных CDN\n    // Например, для Cloudinary, ImageKit и т.д.\n    \n    // Для демонстрации добавим параметры качества к URL\n    if (url.includes('pexels.com') || url.includes('unsplash.com')) {\n      return url;\n    }\n    \n    // Для других источников можно добавить параметры\n    const separator = url.includes('?') ? '&' : '?';\n    return `${url}${separator}q=${quality}&auto=format`;\n  };\n\n  const optimizedSrc = getOptimizedSrc(currentSrc);\n\n  // Эффект для предзагрузки изображений\n  useEffect(() => {\n    if (shouldLoad && !isLoaded && !hasError) {\n      const img = new Image();\n      img.src = optimizedSrc;\n      img.onload = handleLoad;\n      img.onerror = handleError;\n    }\n  }, [shouldLoad, optimizedSrc, isLoaded, hasError]);\n\n  if (hasError && !fallbackSrc) {\n    return (\n      <div className={`bg-gray-200 flex items-center justify-center ${className}`}>\n        <ImageOff className=\"h-8 w-8 text-gray-400\" />\n        <span className=\"ml-2 text-gray-500 text-sm\">Failed to load image</span>\n      </div>\n    );\n  }\n\n  return (\n    <div ref={setRefs} className={`relative overflow-hidden ${className}`}>\n      {/* Placeholder */}\n      {!isLoaded && placeholder === 'blur' && (\n        <div className=\"absolute inset-0 bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 animate-pulse\" />\n      )}\n      \n      {!isLoaded && placeholder === 'empty' && (\n        <div className=\"absolute inset-0 bg-gray-200\" />\n      )}\n\n      {/* Основное изображение */}\n      {shouldLoad && (\n        <img\n          src={optimizedSrc}\n          alt={alt}\n          sizes={sizes}\n          loading={loading}\n          onLoad={handleLoad}\n          onError={handleError}\n          className={`w-full h-full object-cover transition-opacity duration-300 ${\n            isLoaded ? 'opacity-100' : 'opacity-0'\n          }`}\n          style={{\n            position: isLoaded ? 'relative' : 'absolute',\n            top: 0,\n            left: 0\n          }}\n        />\n      )}\n      \n      {/* Индикатор загрузки */}\n      {!isLoaded && shouldLoad && !hasError && (\n        <div className=\"absolute inset-0 flex items-center justify-center\">\n          <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin\" />\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default OptimizedImage;\n\n// Компонент для отображения галереи изображений\nexport const ImageGallery: React.FC<{\n  images: string[];\n  alt: string;\n  className?: string;\n}> = ({ images, alt, className = '' }) => {\n  const [selectedImage, setSelectedImage] = useState(0);\n\n  if (!images || images.length === 0) {\n    return (\n      <div className={`bg-gray-200 flex items-center justify-center ${className}`}>\n        <ImageOff className=\"h-16 w-16 text-gray-400\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className={className}>\n      {/* Основное изображение */}\n      <div className=\"mb-4\">\n        <OptimizedImage\n          src={images[selectedImage]}\n          alt={`${alt} - Image ${selectedImage + 1}`}\n          className=\"w-full h-96 rounded-lg\"\n          loading=\"eager\"\n        />\n      </div>\n      \n      {/* Миниатюры */}\n      {images.length > 1 && (\n        <div className=\"flex space-x-2 overflow-x-auto pb-2\">\n          {images.map((image, index) => (\n            <button\n              key={index}\n              onClick={() => setSelectedImage(index)}\n              className={`flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition-all ${\n                selectedImage === index\n                  ? 'border-blue-600 ring-2 ring-blue-200'\n                  : 'border-gray-200 hover:border-gray-300'\n              }`}\n            >\n              <OptimizedImage\n                src={image}\n                alt={`${alt} thumbnail ${index + 1}`}\n                className=\"w-full h-full\"\n                loading=\"lazy\"\n              />\n            </button>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n};\n"